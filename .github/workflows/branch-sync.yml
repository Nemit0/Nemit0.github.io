name: Sync content branch with main

on:
  push:
    branches:
      - main
      - content
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  content-to-main:
    if: ${{ github.ref == 'refs/heads/content' && github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    env:
      SOURCE_BRANCH: content
      TARGET_BRANCH: main
    steps:
      - name: Ensure target branch exists
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const branch = process.env.TARGET_BRANCH;
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`,
              });
              core.setOutput('exists', 'true');
            } catch (error) {
              core.info(`Branch ${branch} not found, skipping merge.`);
              core.setOutput('exists', 'false');
            }
      - name: Merge content into main
        if: steps.check.outputs.exists == 'true'
        uses: peter-evans/merge-branch@v6
        with:
          head: ${{ env.SOURCE_BRANCH }}
          base: ${{ env.TARGET_BRANCH }}
          commit_message_template: "chore: sync content -> main"
          merge_method: merge

  main-to-content:
    if: ${{ github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    env:
      SOURCE_BRANCH: main
      TARGET_BRANCH: content
    steps:
      - name: Ensure target branch exists
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const branch = process.env.TARGET_BRANCH;
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`,
              });
              core.setOutput('exists', 'true');
            } catch (error) {
              core.info(`Branch ${branch} not found, skipping merge.`);
              core.setOutput('exists', 'false');
            }
      - name: Merge main into content
        if: steps.check.outputs.exists == 'true'
        uses: peter-evans/merge-branch@v6
        with:
          head: ${{ env.SOURCE_BRANCH }}
          base: ${{ env.TARGET_BRANCH }}
          commit_message_template: "chore: sync main -> content"
          merge_method: merge
