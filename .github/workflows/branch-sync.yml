name: Sync content branch with main

on:
  push:
    branches:
      - main
      - content
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  content-to-main:
    if: ${{ github.ref == 'refs/heads/content' && github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    env:
      SOURCE_BRANCH: content
      TARGET_BRANCH: main
    steps:
      - name: Ensure target branch exists
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const branch = process.env.TARGET_BRANCH;
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`,
              });
              core.setOutput('exists', 'true');
            } catch (error) {
              core.info(`Branch ${branch} not found, skipping merge.`);
              core.setOutput('exists', 'false');
            }
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.SOURCE_BRANCH }}
          fetch-depth: 0

      - name: Merge content into main
        if: steps.check.outputs.exists == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin $TARGET_BRANCH $SOURCE_BRANCH
          git switch --detach origin/$TARGET_BRANCH
          git merge --no-ff --no-edit origin/$SOURCE_BRANCH
          git push origin HEAD:$TARGET_BRANCH

  main-to-content:
    if: ${{ github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    env:
      SOURCE_BRANCH: main
      TARGET_BRANCH: content
    steps:
      - name: Ensure target branch exists
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const branch = process.env.TARGET_BRANCH;
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`,
              });
              core.setOutput('exists', 'true');
            } catch (error) {
              core.info(`Branch ${branch} not found, skipping merge.`);
              core.setOutput('exists', 'false');
            }
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.SOURCE_BRANCH }}
          fetch-depth: 0

      - name: Merge main into content
        if: steps.check.outputs.exists == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin $TARGET_BRANCH $SOURCE_BRANCH
          git switch --detach origin/$TARGET_BRANCH
          git merge --no-ff --no-edit origin/$SOURCE_BRANCH
          git push origin HEAD:$TARGET_BRANCH
