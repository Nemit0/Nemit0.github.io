name: Sync content branch with main

on:
  push:
    branches:
      - main
      - content
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  CONTENT_BRANCH: content
  MAIN_BRANCH: main

jobs:
  content-to-main:
    if: github.ref == format('refs/heads/{0}', env.CONTENT_BRANCH) && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Ensure target branch exists
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const branch = process.env.MAIN_BRANCH;
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`,
              });
              core.setOutput('exists', 'true');
            } catch (error) {
              core.info(`Branch ${branch} not found, skipping merge.`);
              core.setOutput('exists', 'false');
            }
      - name: Merge content into main
        if: steps.check.outputs.exists == 'true'
        uses: peter-evans/merge-branch@v6
        with:
          head: ${{ env.CONTENT_BRANCH }}
          base: ${{ env.MAIN_BRANCH }}
          commit_message_template: "chore: sync content -> main"
          merge_method: merge

  main-to-content:
    if: github.ref == format('refs/heads/{0}', env.MAIN_BRANCH) && github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Ensure target branch exists
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const branch = process.env.CONTENT_BRANCH;
            try {
              await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `heads/${branch}`,
              });
              core.setOutput('exists', 'true');
            } catch (error) {
              core.info(`Branch ${branch} not found, skipping merge.`);
              core.setOutput('exists', 'false');
            }
      - name: Merge main into content
        if: steps.check.outputs.exists == 'true'
        uses: peter-evans/merge-branch@v6
        with:
          head: ${{ env.MAIN_BRANCH }}
          base: ${{ env.CONTENT_BRANCH }}
          commit_message_template: "chore: sync main -> content"
          merge_method: merge
